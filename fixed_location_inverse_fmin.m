                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     clc;
clear all;
close all;

% Control parameters:
sanity = 0;        %% Dummy, change it
type = 'N';     % 1.Boundary type switch,  D--> Dirichlet, N --> Neumann.  
constrt = 1;
method = 1;    % 1 for fmincon, 2 for simulated annealing, 3 for hybrid
lambda_inv = 0.1; % Tichnov Regularisation for the inverse problem
%%%% Use geo_generate routine to generate artificial data
%%%% Load geometry 
load('geo.mat')
load('geo2.mat')

%%%% Use data_generate routine to generate artificial data
%%%% Load data
load('datafixloc.mat')

x0 = randn(n_source,1);

% f_c = @(x_plot,y_plot) circle_con_fixloc(x_plot,y_plot);    
f = @(S)BEM_getR_fixloc( S,x_plot,y_plot,x,y,xx,yy,nx,...
                         ny,xm,ym,lx,ly,l,sanity,xd,yd,...
                         f_measure_noisy,lambda_inv,alph_tik);
                     

%%%%%%%%%%%%%%% Constraint %%%%%%%%%%%%%%%%%%%%%%%%%%                     
Aa = [(ones(n_source,1))'];    % Make it flexible for more than 2 sources
ba = [0];
K=2;
% lb = [-K*ones(n_source,1); -ones(2*n_source,1)]';
lb = [-K*ones(n_source,1)]';
ub = -lb;
opts = optimoptions(@fminunc,'PlotFcns',{@optimplotfval,@optimplotx},...
    'MaxIterations',10000,'MaxFunctionEvaluations',60000,...
    'OptimalityTolerance',1e-10,'StepTolerance',1e-10);
problem = createOptimProblem('fmincon','x0',x0, ...
    'objective',f,'Aeq',Aa,'beq',ba,'lb',lb,'ub',ub,...
    'options',opts);

% Gradient methods:
[S_inv,fval,exitflag,output] = fmincon(problem); 
% S_plot1=reshape(S,s1,s2);
% S_plot2=reshape(x_invsoln,s1,s2);
close all;                 
% fixloc_plot( S_plot1,S_plot2,x_plot,y_plot,x_fxloc,y_fxloc )
figure(2)
scatter(x_plot,y_plot,50,S,'filled');
figure(3)
scatter(x_plot,y_plot,50,S_inv,'filled');
figure(4)
plot(S); hold on;plot(S_inv,'*'); hold on; plot(S_inv)
figure(5)
plot(abs((S-S_inv)./S))

% size1 = length(S)/2;
% size2 = length(S) - size1;
% img1 = reshape(S,size1,size2);
% img2 = reshape(x_invsoln,size1,size2);
figure(6)
trisurf(tri,x_plot,y_plot,S);
caxis([-1 1])
figure(7)
trisurf(tri,x_plot,y_plot,S_inv);
caxis([-1 1])

%%%%%%Returning the inv soln to measurement data%

    n_e = length(xd);
    n_source = length(S_inv);
    for m=1:n_e
          F = integrals(l,nx,ny,xx,yy,xd(m),yd(m),lx,ly);
          f_recon(m) =  2*(F(2,:)*ff' - F(1,:)*g');
    end
    [ Se ] = fixloc_getSe(  n_e,n_source,xd,yd,x_plot,y_plot );
    ve = Se*S;
    f_recon = f_recon + ve';
    figure(9)
    plot(f_data); hold on; plot(f_recon,'*')
